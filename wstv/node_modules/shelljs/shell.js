// Copyright (c) 2012 Artur Adib

// Copyright (c) 2010 Ryan McGrath

// http://www.opensource.org/licenses/mit-license.php

function _cd(e,t){t||error("directory not specified"),fs.existsSync(t)||error("no such file or directory: "+t),fs.existsSync(t)&&!fs.statSync(t).isDirectory()&&error("not a directory: "+t),process.chdir(t)}function _pwd(e){var t=path.resolve(process.cwd());return ShellString(t)}function _ls(e,t){function r(t,r){return path.basename(t)[0]!=="."||!!e.all||path.basename(r)[0]==="."&&path.basename(r).length>1?(platform==="win"&&(t=t.replace(/\\/g,"/")),n.push(t),!0):!1}e=parseOptions(e,{R:"recursive",a:"all"}),t?typeof t=="object"?t=t:typeof t=="string"&&(t=[].slice.call(arguments,1)):t=["."];var n=[];return t.forEach(function(t){if(fs.existsSync(t)){if(fs.statSync(t).isFile()){r(t,t);return}if(fs.statSync(t).isDirectory()){fs.readdirSync(t).forEach(function(i){if(!r(i,t))return;if(e.recursive){var s=_pwd();_cd("",t),fs.statSync(i).isDirectory()&&(n=n.concat(_ls("-R"+(e.all?"a":""),i+"/*"))),_cd("",s)}});return}}var i=path.basename(t),s=path.dirname(t);if(i.search(/\*/)>-1&&fs.existsSync(s)&&fs.statSync(s).isDirectory){var o=i.replace(/(\^|\$|\(|\)|\<|\>|\[|\]|\{|\}|\.|\+|\?)/g,"\\$1");o="^"+o.replace(/\*/g,".*")+"$",fs.readdirSync(s).forEach(function(t){if(t.match(new RegExp(o))){if(!r(path.normalize(s+"/"+t),i))return;if(e.recursive){var u=s+"/"+t;fs.statSync(u).isDirectory()&&(n=n.concat(_ls("-R"+(e.all?"a":""),u+"/*")))}}});return}error("no such file or directory: "+t,!0)}),n}function _find(e,t){function r(e){platform==="win"&&(e=e.replace(/\\/g,"/")),n.push(e)}t?typeof t=="object"?t=t:typeof t=="string"&&(t=[].slice.call(arguments,1)):error("no path specified");var n=[];return t.forEach(function(e){r(e),fs.statSync(e).isDirectory()&&_ls("-Ra",e+"/*").forEach(function(e){r(e)})}),n}function _cp(e,t,n){e=parseOptions(e,{f:"force",R:"recursive",r:"recursive"}),arguments.length<3?error("missing <source> and/or <dest>"):arguments.length>3?(t=[].slice.call(arguments,1,arguments.length-1),n=arguments[arguments.length-1]):typeof t=="string"?t=[t]:"length"in t?t=t:error("invalid arguments"),(!fs.existsSync(n)||!fs.statSync(n).isDirectory())&&t.length>1&&error("dest is not a directory (too many sources)"),fs.existsSync(n)&&fs.statSync(n).isFile()&&!e.force&&error("dest file already exists: "+n),t=expand(t),t.forEach(function(t){if(!fs.existsSync(t)){error("no such file or directory: "+t,!0);return}if(fs.statSync(t).isDirectory()){if(!e.recursive)log(t+" is a directory (not copied)");else{var r=n+"/"+path.basename(t),i=fs.statSync(t);try{fs.mkdirSync(r,i.mode)}catch(s){if(s.code!=="EEXIST")throw s}cpdirSyncRecursive(t,r,{force:e.force})}return}var o=n;fs.existsSync(n)&&fs.statSync(n).isDirectory()&&(o=path.normalize(n+"/"+path.basename(t)));if(fs.existsSync(o)&&!e.force){error("dest file already exists: "+o,!0);return}copyFileSync(t,o)})}function _rm(e,t){e=parseOptions(e,{f:"force",r:"recursive",R:"recursive"}),t||error("no paths given"),typeof t=="string"&&(t=[].slice.call(arguments,1)),t=expand(t),t.forEach(function(t){if(!fs.existsSync(t)){e.force||error("no such file or directory: "+t,!0);return}if(fs.statSync(t).isFile()){if(e.force){_unlinkSync(t);return}isWriteable(t)?_unlinkSync(t):error("permission denied: "+t,!0);return}if(fs.statSync(t).isDirectory()&&!e.recursive){error("path is a directory",!0);return}fs.statSync(t).isDirectory()&&e.recursive&&rmdirSyncRecursive(t,e.force)})}function _mv(e,t,n){e=parseOptions(e,{f:"force"}),arguments.length<3?error("missing <source> and/or <dest>"):arguments.length>3?(t=[].slice.call(arguments,1,arguments.length-1),n=arguments[arguments.length-1]):typeof t=="string"?t=[t]:"length"in t?t=t:error("invalid arguments"),t=expand(t),(!fs.existsSync(n)||!fs.statSync(n).isDirectory())&&t.length>1&&error("dest is not a directory (too many sources)"),fs.existsSync(n)&&fs.statSync(n).isFile()&&!e.force&&error("dest file already exists: "+n),t.forEach(function(t){if(!fs.existsSync(t)){error("no such file or directory: "+t,!0);return}var r=n;fs.existsSync(n)&&fs.statSync(n).isDirectory()&&(r=path.normalize(n+"/"+path.basename(t)));if(fs.existsSync(r)&&!e.force){error("dest file already exists: "+r,!0);return}if(path.resolve(t)===path.dirname(path.resolve(r))){error("cannot move to self: "+t,!0);return}fs.renameSync(t,r)})}function _mkdir(e,t){e=parseOptions(e,{p:"fullpath"}),t||error("no paths given"),typeof t=="string"&&(t=[].slice.call(arguments,1)),t.forEach(function(t){if(fs.existsSync(t)){e.fullpath||error("path already exists: "+t,!0);return}var n=path.dirname(t);if(!fs.existsSync(n)&&!e.fullpath){error("no such file or directory: "+n,!0);return}e.fullpath?mkdirSyncRecursive(t):fs.mkdirSync(t,511)})}function _test(e,t){t||error("no path given"),e=parseOptions(e,{d:"directory",f:"file"}),!e.directory&&!e.file&&error("could not interpret expression");if(e.directory)return fs.existsSync(t)&&fs.statSync(t).isDirectory();if(e.file)return fs.existsSync(t)&&fs.statSync(t).isFile()}function _cat(e,t){var n="";return t||error("no paths given"),typeof t=="string"&&(t=[].slice.call(arguments,1)),t=expand(t),t.forEach(function(e){fs.existsSync(e)||error("no such file or directory: "+e),n+=fs.readFileSync(e,"utf8")+"\n"}),n[n.length-1]==="\n"&&(n=n.substring(0,n.length-1)),ShellString(n)}function _to(e,t){t||error("wrong arguments"),fs.existsSync(path.dirname(t))||error("no such file or directory: "+path.dirname(t));try{fs.writeFileSync(t,this.toString(),"utf8")}catch(n){error("could not write to file (code "+n.code+"): "+t,!0)}}function ShellString(e){return e}function _sed(e,t,n,r){e=parseOptions(e,{i:"inplace"}),typeof n=="string"?n=n:typeof n=="number"?n=n.toString():error("invalid replacement string"),r||error("no file given"),fs.existsSync(r)||error("no such file or directory: "+r);var i=fs.readFileSync(r,"utf8").replace(t,n);return e.inplace&&fs.writeFileSync(r,i,"utf8"),ShellString(i)}function _grep(e,t,n){e=parseOptions(e,{v:"inverse"}),n||error("no paths given"),typeof n=="string"&&(n=[].slice.call(arguments,2)),n=expand(n);var r="";return n.forEach(function(n){if(!fs.existsSync(n)){error("no such file or directory: "+n,!0);return}var i=fs.readFileSync(n,"utf8"),s=i.split(/\r*\n/);s.forEach(function(n){var i=n.match(t);if(e.inverse&&!i||!e.inverse&&i)r+=n+"\n"})}),ShellString(r)}function _which(e,t){t||error("must specify command");var n=process.env.path||process.env.Path||process.env.PATH,r=splitPath(n),i=null;return t.search(/\//)===-1&&r.forEach(function(e){if(i)return;var n=path.resolve(e+"/"+t);if(fs.existsSync(n)){i=n;return}if(platform==="win"){var r=n;n=r+".exe";if(fs.existsSync(n)){i=n;return}n=r+".cmd";if(fs.existsSync(n)){i=n;return}n=r+".bat";if(fs.existsSync(n)){i=n;return}}}),!fs.existsSync(t)&&!i?null:(i=i||path.resolve(t),ShellString(i))}function _echo(e){var t=[].slice.call(arguments,1);return console.log.apply(this,t),ShellString(t.join(" "))}function _exec(e,t,n){return e||error("must specify command"),typeof t=="function"&&(n=t,t={}),t=extend({silent:state.silent,async:!1},t),t.async?execAsync(e,t,n):execSync(e,t)}function _exists(e,t){deprecate("exists","Use test() instead."),t||error("no paths given"),typeof t=="string"&&(t=[].slice.call(arguments,1));var n=!0;return t.forEach(function(e){fs.existsSync(e)||(n=!1)}),n}function log(){state.silent||console.log.apply(this,arguments)}function deprecate(e,t){console.log("*** ShellJS."+e+": This function is deprecated.",t)}function write(e){state.silent||process.stdout.write(e)}function error(e,t){state.error===null&&(state.error=""),state.error+=state.currentCmd+": "+e+"\n",log(state.error);if(!t)throw""}function parseOptions(e,t){t||error("parseOptions() internal error: no map given");var n={};for(var r in t)n[t[r]]=!1;if(!e)return n;typeof e!="string"&&error("parseOptions() internal error: wrong str");var i=e.match(/^\-(.+)/);if(!i)return n;var s=i[1].split("");return s.forEach(function(e){e in t?n[t[e]]=!0:error("option not recognized: "+e)}),n}function wrap(e,t,n){return function(){var r=null;state.currentCmd=e,state.error=null;try{var i=[].slice.call(arguments,0);n&&n.notUnix?r=t.apply(this,i):((i.length===0||typeof i[0]!="string"||i[0][0]!=="-")&&i.unshift(""),r=t.apply(this,i))}catch(s){state.error||(console.log("shell.js: internal error"),console.log(s.stack||s),process.exit(1));if(state.fatal)throw s}return state.currentCmd="shell.js",r}}function copyFileSync(e,t){fs.existsSync(e)||error("copyFileSync: no such file or directory: "+e);var n=65536,r=new Buffer(n),i=n,s=0,o=null,u=null;try{o=fs.openSync(e,"r")}catch(a){error("copyFileSync: could not read src file ("+e+")")}try{u=fs.openSync(t,"w")}catch(a){error("copyFileSync: could not write to dest file (code="+a.code+"):"+t)}while(i===n)i=fs.readSync(o,r,0,n,s),fs.writeSync(u,r,0,i),s+=i;fs.closeSync(o),fs.closeSync(u)}function cpdirSyncRecursive(e,t,n){n||(n={});var r=fs.statSync(e);try{fs.mkdirSync(t,r.mode)}catch(i){if(i.code!=="EEXIST")throw i}var s=fs.readdirSync(e);for(var o=0;o<s.length;o++){var u=fs.lstatSync(e+"/"+s[o]);if(u.isDirectory())cpdirSyncRecursive(e+"/"+s[o],t+"/"+s[o],n);else if(u.isSymbolicLink()){var a=fs.readlinkSync(e+"/"+s[o]);fs.symlinkSync(a,t+"/"+s[o])}else fs.existsSync(t+"/"+s[o])&&!n.force?log("skipping existing file: "+s[o]):copyFileSync(e+"/"+s[o],t+"/"+s[o])}}function rmdirSyncRecursive(e,t){var n;n=fs.readdirSync(e);for(var r=0;r<n.length;r++){var i=e+"/"+n[r],s=fs.lstatSync(i);if(s.isDirectory())rmdirSyncRecursive(i,t);else if(s.isSymbolicLink()){if(t||isWriteable(i))try{_unlinkSync(i)}catch(o){error("could not remove file (code "+o.code+"): "+i,!0)}}else if(t||isWriteable(i))try{_unlinkSync(i)}catch(o){error("could not remove file (code "+o.code+"): "+i,!0)}}var u;try{u=fs.rmdirSync(e)}catch(o){error("could not remove directory (code "+o.code+"): "+e,!0)}return u}function mkdirSyncRecursive(e){var t=path.dirname(e);if(fs.existsSync(t)){fs.mkdirSync(e,511);return}mkdirSyncRecursive(t),fs.mkdirSync(e,511)}function randomFileName(){function e(t){if(t===1)return parseInt(16*Math.random()).toString(16);var n="";for(var r=0;r<t;r++)n+=e(1);return n}return"makerjs_"+e(20)}function writeableDir(e){if(!e||!fs.existsSync(e))return!1;if(!fs.statSync(e).isDirectory())return!1;var t=e+"/"+randomFileName();try{return fs.writeFileSync(t," "),_unlinkSync(t),e}catch(n){return!1}}function tempDir(){return state.tempDir?state.tempDir:(state.tempDir=writeableDir(process.env.TMPDIR)||writeableDir(process.env.TEMP)||writeableDir(process.env.TMP)||writeableDir(process.env.Wimp$ScrapDir)||writeableDir("C:\\TEMP")||writeableDir("C:\\TMP")||writeableDir("\\TEMP")||writeableDir("\\TMP")||writeableDir("/tmp")||writeableDir("/var/tmp")||writeableDir("/usr/tmp")||writeableDir("."),state.tempDir)}function execAsync(e,t,n){var r="",i=extend({silent:state.silent},t),s=child.exec(e,{env:process.env},function(e){n&&n(e?e.code:0,r)});return s.stdout.on("data",function(e){r+=e,i.silent||process.stdout.write(e)}),s.stderr.on("data",function(e){r+=e,i.silent||process.stdout.write(e)}),s}function execSync(e,t){function a(){if(o.silent||!fs.existsSync(n))return;var e=fs.readFileSync(n,"utf8");if(e.length<=u.length)return;process.stdout.write(e.substr(u.length)),u=e}function f(e){return e=e.replace(/\'/g,'"'),e=e.replace(/\\/g,"\\\\"),e}var n=path.resolve(tempDir()+"/"+randomFileName()),r=path.resolve(tempDir()+"/"+randomFileName()),i=path.resolve(tempDir()+"/"+randomFileName()),s=path.resolve(tempDir()+"/"+randomFileName()),o=extend({silent:state.silent},t),u="";e+=" > "+n+" 2>&1";var l="var child = require('child_process'),         fs = require('fs');     child.exec('"+f(e)+"', {env: process.env}, function(err) {       fs.writeFileSync('"+f(r)+"', err ? err.code.toString() : '0');     });";fs.existsSync(i)&&_unlinkSync(i),fs.existsSync(n)&&_unlinkSync(n),fs.existsSync(r)&&_unlinkSync(r),fs.writeFileSync(i,l),child.exec("node "+i,{env:process.env,cwd:exports.pwd()});while(!fs.existsSync(r))a(),fs.writeFileSync(s,"a");while(!fs.existsSync(n))a(),fs.writeFileSync(s,"a");var c=parseInt("");while(isNaN(c))c=parseInt(fs.readFileSync(r,"utf8"));var h=fs.readFileSync(n,"utf8");try{_unlinkSync(i)}catch(p){}try{_unlinkSync(n)}catch(p){}try{_unlinkSync(r)}catch(p){}try{_unlinkSync(s)}catch(p){}var d={code:c,output:h};return d}function expand(e){var t=[];return e.forEach(function(e){e.search(/\*/)>-1?_ls("",e).forEach(function(e){t.push(e)}):t.push(e)}),t}function splitPath(e){return e?platform==="win"?e.split(";"):e.split(":"):[]}function extend(e){var t=[].slice.call(arguments,1);return t.forEach(function(t){for(var n in t)e[n]=t[n]}),e}function _unlinkSync(e){try{fs.unlinkSync(e)}catch(t){if(t.code!=="EPERM")throw t;fs.chmodSync(e,"0666"),fs.unlinkSync(e)}}function isWriteable(e){var t=!0;try{var n=fs.openSync(e,"a");fs.closeSync(n)}catch(r){t=!1}return t}var fs=require("fs"),path=require("path"),util=require("util"),vm=require("vm"),child=require("child_process"),os=require("os");fs.existsSync=fs.existsSync||path.existsSync;var state={error:null,fatal:!1,silent:!1,currentCmd:"shell.js",tempDir:null},platform=os.type().match(/^Win/)?"win":"unix";exports.cd=wrap("cd",_cd),exports.pwd=wrap("pwd",_pwd),exports.ls=wrap("ls",_ls),exports.find=wrap("find",_find),exports.cp=wrap("cp",_cp),exports.rm=wrap("rm",_rm),exports.mv=wrap("mv",_mv),exports.mkdir=wrap("mkdir",_mkdir),exports.test=wrap("test",_test),exports.cat=wrap("cat",_cat),String.prototype.to=wrap("to",_to),exports.sed=wrap("sed",_sed),exports.grep=wrap("grep",_grep),exports.which=wrap("which",_which),exports.echo=wrap("echo",_echo),exports.exit=process.exit,exports.env=process.env,exports.exec=wrap("exec",_exec,{notUnix:!0}),exports.tempdir=wrap("tempdir",tempDir),exports.error=function(){return state.error},exports.silent=function(e){if(typeof e!="boolean")return state.silent;state.silent=e},exports.exists=wrap("exists",_exists),exports.verbose=function(){deprecate("verbose","Use silent(false) instead."),state.silent=!1};